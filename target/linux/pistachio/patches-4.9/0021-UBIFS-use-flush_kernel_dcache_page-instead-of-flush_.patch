From 59c67233e5939e88f72d17ed060690e83e947ca3 Mon Sep 17 00:00:00 2001
From: Ionela Voinescu <ionela.voinescu@imgtec.com>
Date: Mon, 22 Feb 2016 16:36:13 +0000
Subject: [PATCH 21/40] UBIFS: use flush_kernel_dcache_page instead of
 flush_dcache_page

When the kernel needs to modify a user page it has obtained with
kmap, it should call this function  after all modifications are
complete, but before kunmapping it, to bring L2 caches and underlying
memory up to date.
This is the behavior we see for UBIFS read/writepage and therefore
flush_kernel_dcache_page should be used instead of flush_dcache_page.
By comparison, flush_dcache_page is used at any time the kernel
writes to a page in the page cache or reads from a page in the page cache
with potential shared/writable userspace mappings.

Change-Id: Ie017e8718f87c326f7f7f58f803a38dd5bf0b70c
Signed-off-by: Ionela Voinescu <ionela.voinescu@imgtec.com>
---
 fs/ubifs/file.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/fs/ubifs/file.c b/fs/ubifs/file.c
index b4fbeef..06149081 100644
--- a/fs/ubifs/file.c
+++ b/fs/ubifs/file.c
@@ -177,7 +177,7 @@ static int do_readpage(struct page *page)
 out:
 	SetPageUptodate(page);
 	ClearPageError(page);
-	flush_dcache_page(page);
+	flush_kernel_dcache_page(page);
 	kunmap(page);
 	return 0;
 
@@ -185,7 +185,7 @@ static int do_readpage(struct page *page)
 	kfree(dn);
 	ClearPageUptodate(page);
 	SetPageError(page);
-	flush_dcache_page(page);
+	flush_kernel_dcache_page(page);
 	kunmap(page);
 	return err;
 }
@@ -688,7 +688,7 @@ static int populate_page(struct ubifs_info *c, struct page *page,
 
 	SetPageUptodate(page);
 	ClearPageError(page);
-	flush_dcache_page(page);
+	flush_kernel_dcache_page(page);
 	kunmap(page);
 	*n = nn;
 	return 0;
@@ -696,7 +696,7 @@ static int populate_page(struct ubifs_info *c, struct page *page,
 out_err:
 	ClearPageUptodate(page);
 	SetPageError(page);
-	flush_dcache_page(page);
+	flush_kernel_dcache_page(page);
 	kunmap(page);
 	ubifs_err(c, "bad data node (block %u, inode %lu)",
 		  page_block, inode->i_ino);
@@ -1047,7 +1047,7 @@ static int ubifs_writepage(struct page *page, struct writeback_control *wbc)
 	 */
 	kaddr = kmap_atomic(page);
 	memset(kaddr + len, 0, PAGE_SIZE - len);
-	flush_dcache_page(page);
+	flush_kernel_dcache_page(page);
 	kunmap_atomic(kaddr);
 
 	if (i_size > synced_i_size) {
-- 
2.7.4

