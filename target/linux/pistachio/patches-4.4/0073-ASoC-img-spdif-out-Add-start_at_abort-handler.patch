From e6ab5d036f168030b59b2e526d49a49a5047787e Mon Sep 17 00:00:00 2001
From: Francois Berder <francois.berder@imgtec.com>
Date: Fri, 3 Feb 2017 10:10:39 +0000
Subject: [PATCH 73/87] ASoC: img: spdif-out: Add start_at_abort handler

Signed-off-by: Francois Berder <francois.berder@imgtec.com>
Signed-off-by: Damien.Horsley <Damien.Horsley@imgtec.com>
---
 sound/soc/img/img-spdif-out.c | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/sound/soc/img/img-spdif-out.c b/sound/soc/img/img-spdif-out.c
index 08f93a5..f4367f0 100644
--- a/sound/soc/img/img-spdif-out.c
+++ b/sound/soc/img/img-spdif-out.c
@@ -279,9 +279,24 @@ static int img_spdif_out_hw_params(struct snd_pcm_substream *substream,
 	return 0;
 }
 
+static int img_spdif_out_start_at_abort(struct snd_pcm_substream *substream,
+		struct snd_soc_dai *cpu_dai)
+{
+	struct img_spdif_out *spdif = snd_soc_dai_get_drvdata(cpu_dai);
+	unsigned long flags;
+
+	spin_lock_irqsave(&spdif->lock, flags);
+	img_spdif_out_reset(spdif);
+	spin_unlock_irqrestore(&spdif->lock, flags);
+
+	return 0;
+}
+
+
 static const struct snd_soc_dai_ops img_spdif_out_dai_ops = {
 	.trigger = img_spdif_out_trigger,
-	.hw_params = img_spdif_out_hw_params
+	.hw_params = img_spdif_out_hw_params,
+	.start_at_abort = img_spdif_out_start_at_abort
 };
 
 static int img_spdif_out_dai_probe(struct snd_soc_dai *dai)
-- 
2.7.4

