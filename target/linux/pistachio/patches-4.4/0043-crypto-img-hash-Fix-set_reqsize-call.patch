From 9ced7f4becd3b5e17ff5ad13a8c0f8993d2d8fa4 Mon Sep 17 00:00:00 2001
From: Will Thomas <will.thomas@imgtec.com>
Date: Fri, 5 Aug 2016 14:00:20 +0100
Subject: [PATCH 43/74] crypto: img-hash - Fix set_reqsize call

Properly allocate enough memory to respect the fallback.

Signed-off-by: Will Thomas <will.thomas@imgtec.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
---
 drivers/crypto/img-hash.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/crypto/img-hash.c b/drivers/crypto/img-hash.c
index 60410d7..a2e77b8 100644
--- a/drivers/crypto/img-hash.c
+++ b/drivers/crypto/img-hash.c
@@ -686,6 +686,7 @@ static int img_hash_cra_init(struct crypto_tfm *tfm, const char *alg_name)
 	}
 	crypto_ahash_set_reqsize(__crypto_ahash_cast(tfm),
 				 sizeof(struct img_hash_request_ctx) +
+				 crypto_ahash_reqsize(ctx->fallback) +
 				 IMG_HASH_DMA_THRESHOLD);
 
 	return 0;
-- 
2.7.4

